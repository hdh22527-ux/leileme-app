<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´¯äº†ä¹ˆ - AIå¿ƒç†æ„ˆå¿ƒç©ºé—´</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3062/3062634.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3062/3062634.png">
    
    <style>
        :root { --primary: #6c5ce7; --bg: #f8f9fa; --bot-msg: #f1f0f0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); box-sizing: border-box; margin-bottom: 20px; }
        #chart-area { height: 150px; width: 100%; margin-bottom: 10px; }
        #chat-window { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .msg { padding: 14px; border-radius: 16px; max-width: 85%; font-size: 1rem; line-height: 1.6; word-wrap: break-word; }
        .bot { background: var(--bot-msg); align-self: flex-start; color: #2d3436; border-bottom-left-radius: 4px; }
        .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 14px; border: 1px solid #ddd; border-radius: 12px; outline: none; font-size: 1rem; }
        button { background: var(--primary); color: white; border: none; padding: 0 25px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .loading { font-size: 0.85rem; color: #a29bfe; display: none; margin-bottom: 10px; text-align: center; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .level-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="card">
        <h3 style="margin-top:0; font-size:1rem; text-align:center;">ä»Šæ—¥ç–²åŠ³è¶‹åŠ¿</h3>
        <div id="chart-area"><canvas id="myChart"></canvas></div>
        <div class="btn-group">
            <button class="level-btn" style="background:#a8e6cf" onclick="recordStress(0)">ğŸ˜Œè¿˜å¯ä»¥</button>
            <button class="level-btn" style="background:#ffd3b6" onclick="recordStress(2)">ğŸ˜©æŒºç´¯çš„</button>
            <button class="level-btn" style="background:#ff8b94" onclick="recordStress(4)">ğŸ¤¯çˆ†è¡¨äº†</button>
        </div>
    </div>

    <div class="card">
        <h2 style="text-align: center; margin-top: 0; color: var(--primary);">ğŸ§˜ AI æ„ˆå¿ƒç©ºé—´</h2>
        <div id="chat-window">
            <div class="msg bot">ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„ç§äººå¿ƒç†é¡¾é—®ã€‚åœ¨è¿™é‡Œä½ çš„éšç§å—åˆ°ä¿æŠ¤ï¼Œè¯·å‘Šè¯‰æˆ‘æ­¤æ—¶æ­¤åˆ»ä½ çš„æ„Ÿå—ã€‚</div>
        </div>
        <div id="loading-hint" class="loading">AI æ­£åœ¨æ·±åº¦å€¾å¬å¹¶æ€è€ƒ...</div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="è¯´å‡ºä½ çš„å¿ƒå£°..." onkeypress="if(event.keyCode==13) callGPT()">
            <button onclick="callGPT()">å‘é€</button>
        </div>
    </div>

    <script>
        // æ³¨æ„ï¼šè¿™é‡Œå·²ç»ä¸å†æœ‰ MY_SECRET_KEY å˜é‡äº†ï¼Œå®ƒæ˜¯å®‰å…¨çš„ï¼
        let history = JSON.parse(localStorage.getItem('leileme_data')) || [];
        let myChart;

        window.onload = function() { updateChart(); };

        function recordStress(level) {
            let score = 100 - (level * 25);
            let time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            history.push({ time: time, score: score });
            localStorage.setItem('leileme_data', JSON.stringify(history));
            updateChart();
            appendMsg(`è®°å½•æˆåŠŸï¼šå½“å‰å¥åº·æŒ‡æ•° ${score}%`, 'bot');
        }

        // ä¿®æ”¹åçš„å®‰å…¨è°ƒç”¨å‡½æ•°
        async function callGPT() {
            const input = document.getElementById('userInput');
            const userText = input.value.trim();
            if (!userText) return;

            appendMsg(userText, 'user');
            input.value = "";
            document.getElementById('loading-hint').style.display = "block";

            try {
                // æŒ‡å‘ Vercel çš„ Serverless Function è·¯å¾„
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userText })
                });

                const data = await response.json();
                document.getElementById('loading-hint').style.display = "none";
                appendMsg(data.reply, 'bot');
            } catch (error) {
                document.getElementById('loading-hint').style.display = "none";
                appendMsg("ï¼ˆè¿æ¥ç¨å¾®æœ‰ç‚¹æ‹¥æŒ¤ï¼Œè¯·ç¡®ä¿ Vercel ç¯å¢ƒå˜é‡å·²é…ç½®ã€‚ï¼‰", 'bot');
            }
        }

        function appendMsg(text, sender) {
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerText = text;
            win.appendChild(div);
            win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
        }

        function updateChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            const last7 = history.slice(-7);
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7.map(d => d.time),
                    datasets: [{
                        label: 'å¥åº·è¶‹åŠ¿',
                        data: last7.map(d => d.score),
                        borderColor: '#6c5ce7',
                        fill: true,
                        backgroundColor: 'rgba(108, 92, 231, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } }
            });
        }
    </script>
</body>
</html>