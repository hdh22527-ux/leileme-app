<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„ˆå¿ƒç©ºé—´ - CBT æƒ…ç»ªè‡ªåŠ©å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #6c5ce7; --bg: #f0f2f5; --card: #ffffff; --text: #2d3436; }
        body { font-family: -apple-system, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* èƒ½é‡çŠ¶æ€é€‰æ‹© */
        .status-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 10px; }
        .level-btn { border: none; border-radius: 12px; padding: 10px 5px; cursor: pointer; transition: 0.3s; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .level-btn:active { transform: scale(0.9); }
        .lv1 { background: #e3fdfd; color: #218c74; } /* è“„ç”µæ± æ»¡æ ¼ */
        .lv2 { background: #f1fcf0; color: #4b7bec; } /* è½»å¾®æ¶ˆè€— */
        .lv3 { background: #fff9e6; color: #f39c12; } /* æ„Ÿåˆ°çƒ¦èº */
        .lv4 { background: #fff0e6; color: #e67e22; } /* æ·±åº¦ç–²åŠ³ */
        .lv5 { background: #ffebee; color: #c0392b; } /* æåº¦è€—ç«­ */

        /* èŠå¤©åŒºåŸŸ */
        #chat-window { height: 350px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #f0f0f0; margin-bottom: 15px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.5; }
        .bot { background: #f1f2f6; align-self: flex-start; border-bottom-left-radius: 2px; }
        .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .input-area { display: flex; gap: 8px; }
        input { flex: 1; border: 1px solid #ddd; border-radius: 25px; padding: 12px 20px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); }
        button#send-btn { background: var(--primary); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        #chart-container { height: 180px; position: relative; }
        .loading { font-size: 0.8rem; color: #999; text-align: center; margin-bottom: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h4 style="margin:0 0 10px 0; font-weight: 600;">èº«å¿ƒèƒ½é‡è±¡é™</h4>
        <div id="chart-container"><canvas id="myChart"></canvas></div>
        <div class="status-grid">
            <button class="level-btn lv1" onclick="recordStress(100, 'è“„ç”µæ± æ»¡æ ¼')"><span>ğŸ˜Œ</span>æ»¡æ ¼</button>
            <button class="level-btn lv2" onclick="recordStress(75, 'è½»å¾®æ¶ˆè€—')"><span>ğŸ™‚</span>æ¶ˆè€—</button>
            <button class="level-btn lv3" onclick="recordStress(50, 'æœ‰äº›çƒ¦èº')"><span>ğŸ˜</span>çƒ¦èº</button>
            <button class="level-btn lv4" onclick="recordStress(25, 'æ·±åº¦ç–²åŠ³')"><span>ğŸ˜«</span>ç–²åŠ³</button>
            <button class="level-btn lv5" onclick="recordStress(5, 'æåº¦è€—ç«­')"><span>ğŸ’€</span>è€—ç«­</button>
        </div>
    </div>

    <div class="card">
        <div id="chat-window">
            <div class="msg bot">æ¬¢è¿å›æ¥ã€‚æˆ‘æ˜¯ä½ çš„ CBT å¿ƒç†ä¼™ä¼´ã€‚åˆšæ‰ç‚¹å‡»çš„æŒ‰é’®ä»£è¡¨äº†ä½ æ­¤æ—¶çš„èƒ½é‡çŠ¶æ€ï¼Œæ„¿æ„å’Œæˆ‘èŠèŠå‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿ</div>
        </div>
        <div id="loading" class="loading">æ­£åœ¨æ·±åº¦å€¾å¬...</div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿæˆ‘çš„æƒ³æ³•æ˜¯..." onkeypress="if(event.keyCode==13) callGPT()">
            <button id="send-btn" onclick="callGPT()">â”</button>
        </div>
    </div>
</div>

<script>
    let history = JSON.parse(localStorage.getItem('psy_data')) || [];
    let myChart;

    window.onload = function() { initChart(); };

    function recordStress(score, label) {
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        history.push({ time, score, label });
        if(history.length > 20) history.shift();
        localStorage.setItem('psy_data', JSON.stringify(history));
        updateChart();
        
        let feedback = "";
        if(score <= 25) feedback = `æˆ‘æ³¨æ„åˆ°ä½ ç°åœ¨å¤„äº ${label} çŠ¶æ€ï¼Œè¿™å¾ˆä¸å®¹æ˜“ã€‚è¯·è¯•ç€æ·±å‘¼å¸ä¸‰æ¬¡ï¼Œç„¶åå‘Šè¯‰æˆ‘ï¼Œä½ è„‘æµ·é‡Œç°åœ¨æœ€å…ˆè·³å‡ºæ¥çš„å¿µå¤´æ˜¯ä»€ä¹ˆï¼Ÿ`;
        else if(score >= 75) feedback = `å¤„äº ${label} çŠ¶æ€å¤ªæ£’äº†ï¼æ­¤æ—¶æ­¤åˆ»ï¼Œæœ‰ä»€ä¹ˆå€¼å¾—è®°å½•çš„å°æˆå°±å—ï¼Ÿ`;
        else feedback = `æ”¶åˆ°äº†ï¼Œå½“å‰å¤„äº ${label}ã€‚è®©æˆ‘ä»¬é€šè¿‡å¯¹è¯ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æŠŠèƒ½é‡æ¡å†å¾€ä¸Šæ‹‰ä¸€ç‚¹ã€‚`;
        
        appendMsg(feedback, 'bot');
    }

    async function callGPT() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if(!text) return;

        appendMsg(text, 'user');
        input.value = "";
        document.getElementById('loading').style.display = "block";

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await res.json();
            appendMsg(data.reply, 'bot');
        } catch (e) {
            appendMsg("æŠ±æ­‰ï¼Œæˆ‘çš„æ€ç»ªæ–­äº†ä¸€ä¸‹ï¼Œè¯·å†è·Ÿæˆ‘è¯´è¯´ã€‚", 'bot');
        } finally {
            document.getElementById('loading').style.display = "none";
        }
    }

    function appendMsg(text, sender) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.innerText = text;
        win.appendChild(div);
        win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
    }

    function initChart() {
        const ctx = document.getElementById('myChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: history.map(d => d.time),
                datasets: [{
                    data: history.map(d => d.score),
                    borderColor: '#6c5ce7',
                    backgroundColor: 'rgba(108, 92, 231, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { y: { min: 0, max: 100, ticks: { stepSize: 25 } } }
            }
        });
    }

    function updateChart() {
        myChart.data.labels = history.map(d => d.time);
        myChart.data.datasets[0].data = history.map(d => d.score);
        myChart.update();
    }
</script>
</body>
</html>
