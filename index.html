<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒç´¯è°ƒèŠ‚å™¨ - çº¯äº’åŠ¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #6c5ce7; --bg: #f0f3f7; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; color: #2d3436; }
        
        .card { background: white; width: 100%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* èŠå¤©äº’åŠ¨çª—å£ */
        #chat-window { height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; padding: 15px; background: #fafafa; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .msg { padding: 12px 16px; border-radius: 15px; font-size: 0.95rem; line-height: 1.5; max-width: 85%; }
        .bot { background: #dfe6e9; align-self: flex-start; border-bottom-left-radius: 2px; }
        .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        .input-group { display: flex; gap: 8px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.9; }

        #chart-area { height: 180px; margin-top: 10px; }
        .badge { display: inline-block; padding: 4px 10px; background: #ffeaa7; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <div class="badge">æ•°æ®è§‰å¯Ÿ</div>
        <div style="font-weight: bold; margin-bottom: 10px;">è¿‘ 7 æ¬¡å¿ƒç†è´Ÿè·è¶‹åŠ¿</div>
        <div id="chart-area"><canvas id="stressChart"></canvas></div>
    </div>

    <div class="card">
        <div class="badge">AI è®¤çŸ¥ç–—æ³•åŠ©æ‰‹</div>
        <div id="chat-window">
            <div class="msg bot">ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„å¿ƒç†è‡ªæ•‘åŠ©æ‰‹ã€‚æ„Ÿè§‰åˆ°â€œå¿ƒç´¯â€é€šå¸¸æ˜¯å› ä¸ºå¤§è„‘é™·å…¥äº†æŸç§å¾ªç¯ã€‚</div>
            <div class="msg bot">ç°åœ¨ï¼Œè¯·è¯•ç€ç”¨ä¸€å¥è¯å†™ä¸‹ï¼šæ­¤æ—¶æ­¤åˆ»ï¼Œè®©ä½ è§‰å¾—æœ€æ²‰é‡ã€æœ€ç–²æƒ«çš„é‚£ä¸ªå¿µå¤´æ˜¯ä»€ä¹ˆï¼Ÿ</div>
        </div>
        
        <div class="input-group">
            <input type="text" id="userInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ€ä¹ˆåšéƒ½æ— æ³•è®©æ‰€æœ‰äººæ»¡æ„..." onkeypress="if(event.keyCode==13) sendMessage()">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <div class="badge">å³æ—¶å¹²é¢„</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button style="background:#55efc4; color:#00b894" onclick="startBreathing()">ğŸ« 4-7-8 å‘¼å¸æ”¾æ¾</button>
            <button style="background:#81ecec; color:#00cec9" onclick="startGrounding()">ğŸ§˜ 5-4-3-2-1 å½’ä½æ³•</button>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒé€»è¾‘å­˜å‚¨
        let history = JSON.parse(localStorage.getItem('psy_data')) || [];
        let chatStep = 0;
        let chartInstance;

        // 1. å‘é€æ¶ˆæ¯é€»è¾‘
        function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;

            appendMsg(text, 'user');
            input.value = "";

            // æ¨¡æ‹Ÿ AI ç–—æ³•é€»è¾‘ï¼ˆCBT å¼•å¯¼ï¼‰
            setTimeout(() => {
                processTherapy(text);
            }, 800);
        }

        function appendMsg(text, sender) {
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerText = text;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        // 2. å¿ƒç†ç–—æ³•äº’åŠ¨çŠ¶æ€æœº
        function processTherapy(text) {
            chatStep++;
            if(chatStep === 1) {
                appendMsg("æ”¶åˆ°äº†ã€‚è¿™ä¸ªå¿µå¤´å¬èµ·æ¥ç¡®å®å¾ˆæ²‰é‡ã€‚ç°åœ¨æˆ‘ä»¬è¯•ç€è§£æ„å®ƒï¼šè¿™ä¸ªæƒ³æ³•æ˜¯â€˜äº‹å®â€™ï¼Œè¿˜æ˜¯ä½ å¯¹è¿™ä»¶äº‹çš„â€˜è§£é‡Šâ€™ï¼Ÿå¦‚æœä½ çš„å¥½æœ‹å‹ä¹Ÿæœ‰åŒæ ·çš„å¿µå¤´ï¼Œä½ ä¼šæ€ä¹ˆå®‰æ…°ä»–ï¼Ÿ", 'bot');
                saveStress(80); // é»˜è®¤é«˜å‹è®°å½•
            } else if(chatStep === 2) {
                appendMsg("å¾ˆæœ‰å¯å‘çš„è§‚å¯Ÿã€‚ä½ çœ‹ï¼Œå½“ä½ ç«™åœ¨æœ‹å‹çš„è§’åº¦ï¼Œé€»è¾‘å°±æ¸…æ™°äº†ã€‚å¿ƒç´¯å¾€å¾€æ˜¯å› ä¸ºæˆ‘ä»¬å¯¹è‡ªå·±å¤ªè‹›åˆ»ã€‚ç°åœ¨ï¼Œè¯·é—­ä¸Šçœ¼ï¼Œåœ¨å¿ƒé‡Œå¯¹è‡ªå·±è¯´ä¸€å¥ï¼šâ€˜è™½ç„¶å¾ˆç´¯ï¼Œä½†æˆ‘å·²ç»å°½åŠ›äº†ï¼Œè¿™å·²ç»è¶³å¤Ÿå¥½äº†ã€‚â€™", 'bot');
            } else {
                appendMsg("ä½ åšå¾—å¾ˆå¥½ã€‚æˆ‘ä»¬è¦è®°ä½ï¼šæƒ³æ³•åªæ˜¯å¤©ä¸Šçš„äº‘ï¼Œè€Œä½ æ˜¯çœ‹äº‘çš„å¤©ç©ºã€‚äº‘ä¼šæ•£å»ï¼Œå¤©ç©ºæ°¸æ’ã€‚éœ€è¦å°è¯•ä¸€ä¸‹å·¦ä¸‹è§’çš„â€˜4-7-8 å‘¼å¸æ³•â€™æ¥æ”¾æ¾èº«ä½“å—ï¼Ÿ", 'bot');
                saveStress(40); // ç¼“è§£åè®°å½•
            }
        }

        // 3. å‘¼å¸æ³•äº’åŠ¨
        function startBreathing() {
            chatStep = 0;
            document.getElementById('chat-window').innerHTML = "";
            appendMsg("å¼€å§‹ 4-7-8 å‘¼å¸æ³•ï¼š\n1. å¸æ°” 4 ç§’...\n2. æ†‹æ°” 7 ç§’...\n3. å‘¼æ°” 8 ç§’...", 'bot');
            appendMsg("è¯·é‡å¤ 3 æ¬¡ã€‚æ„Ÿå—ç©ºæ°”è¿›å…¥è‚ºéƒ¨ï¼Œå¸¦èµ°äºŒæ°§åŒ–ç¢³å’Œå‹åŠ›ã€‚", 'bot');
        }

        // 4. 5-4-3-2-1 å½’ä½æ³• (DBT å¸¸ç”¨ï¼Œç”¨äºæ‰“æ–­ç„¦è™‘)
        function startGrounding() {
            appendMsg("è¿™æ˜¯â€˜ç€é™†æŠ€æœ¯â€™ï¼Œå¸®ä½ çš„å¤§è„‘å›åˆ°å½“ä¸‹ï¼š\nçœ‹åˆ° 5 ä¸ªä¸œè¥¿ï¼›\næ‘¸åˆ° 4 ä¸ªä¸œè¥¿ï¼›\nå¬åˆ° 3 ä¸ªå£°éŸ³ï¼›\né—»åˆ° 2 ä¸ªæ°”å‘³ï¼›\nå°åˆ° 1 ä¸ªå‘³é“ã€‚", 'bot');
        }

        // 5. æ•°æ®ä¿å­˜ä¸å›¾è¡¨
        function saveStress(val) {
            history.push({ t: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), v: val });
            localStorage.setItem('psy_data', JSON.stringify(history));
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('stressChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const last7 = history.slice(-7);
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7.map(d => d.t),
                    datasets: [{
                        label: 'å¿ƒç†è´Ÿè·',
                        data: last7.map(d => d.v),
                        borderColor: '#6c5ce7',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(108, 92, 231, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } }
            });
        }

        window.onload = updateChart;
    </script>
</body>
</html>